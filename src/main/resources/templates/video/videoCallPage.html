<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<style>
    body {
        font-family: 'Apple SD Gothic Neo', sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f8f9fa;
        padding: 40px;
    }

    h2 {
        margin-bottom: 20px;
    }

    .video-wrapper {
        display: flex;
        gap: 20px;
    }

    video {
        width: 400px;
        height: 300px;
        border-radius: 12px;
        border: 3px solid #adb5bd;
        background-color: black;
    }

    button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        background-color: #4dabf7;
        color: white;
        border-radius: 8px;
        cursor: pointer;
    }

    button:hover {
        background-color: #339af0;
    }
</style>

<body>
    <h2>í™”ìƒ í†µí™”</h2>
    <div class="video-wrapper">
        <video id="localVideo" autoplay playsinline muted></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <button onclick="startCamera()">ì‹œì‘í•˜ê¸°</button>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get("roomId" || "defaultRoom");
        const senderId = urlParams.get("userId") || "anonymous";

        let localStream;
        let peerConnection;
        let stompClient = null;

        // êµ¬ê¸€ stun ì„œë²„ 
        const config = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" }
            ]
        };

        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;

                connectSocket(); //STOMP ë¨¼ì € ì—°ê²° 
                setupPeerConnection();

            } catch (err) {
                console.error("ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:", err);
                alert("ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
            }
        }

        function connectSocket() {
            const socket = new SockJS("/ws-chat");
            stompClient = Stomp.over(socket);

            stompClient.connect({}, () => {
                console.log("âœ… STOMP ì—°ê²° ì„±ê³µ");

                stompClient.subscribe(`/topic/signal/${roomId}`, (message) => {
                    const signal = JSON.parse(message.body);
                    console.log("ğŸ“¥ ë°›ì€ ì‹œê·¸ë„:", signal);

                    if (signal.type === "offer") {
                        handleOffer(signal);
                    } else if (signal.type === "answer") {
                        handleAnswer(signal);
                    } else if (signal.type === "ice") {
                        handleIce(signal);
                    }
                })
            })
        }

        function setupPeerConnection() {
            peerConnection = new RTCPeerConnection(config);

            // 1. ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });


            // 2. ICE í›„ë³´ ë°œìƒ ì‹œ ì½˜ì†” ì¶œë ¥
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    console.log("ğŸ“¡ ICE Candidate:", event.candidate);
                    sendSignal("ice", event.candidate); //ice ë„ ì‹œê·¸ë„ ì „ì†¡
                }
            }

            // 3. ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  (ì•„ì§ì€ ì—†ìŒ)
            peerConnection.ontrack = event => {
                console.log("ğŸ“º Remote track received", event.streams[0]);
                // ì¶”í›„ remoteVideoì— ë¶™ì¼ ì˜ˆì •
            }

            // 4. SDP Offer ìƒì„±
            peerConnection.createOffer()
                .then(offer => {
                    return peerConnection.setLocalDescription(offer)
                })
                .then(() => {
                    console.log("ğŸ“„ SDP Offer ìƒì„± ì™„ë£Œ:" + peerConnection.localDescription);
                    sendSignal("offer", peerConnection.localDescription); // âœ… signaling ì„œë²„ë¡œ offer ì „ì†¡
                })
                .catch(err => {
                    console.error("Offer ìƒì„± ì¤‘ ì˜¤ë¥˜:", err);
                })
        }

        

        // signal ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ 
        function sendSignal(type, data) {
            const message = {
                type: type,
                senderId, // ì‹¤ì œ ë¡œê·¸ì¸ ì‚¬ìš©ì IDë¡œ ë³€ê²½ í•„ìš”
                data: data
            };
            stompClient.send(`/app/${type}/${roomId}`, {}, JSON.stringify(message));
        }

        // ìƒëŒ€ë°©ì´ offerë¥¼ ìˆ˜ì‹ í–ˆì„ ë•Œ ìˆ˜í–‰ë˜ëŠ” í•µì‹¬ í•¨ìˆ˜
        async function handleOffer(signal) {
            console.log("handleOffer() - Offer ìˆ˜ì‹ :" + signal);

            const offerDesc = new RTCSessionDescription(signal.data);

            // 1.ìˆ˜ì‹ í•œ offer ë¥¼ remoteDescriptionìœ¼ë¡œ ì„¤ì • 
            await peerConnection.setRemoteDescription(offerDesc);
            console.log("âœ… setRemoteDescription(offer) ì™„ë£Œ");

            // 2.ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ì´ ì—°ê²° ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ì—°ê²° 
            // ìƒëŒ€ë°©ì´ ì˜ìƒí†µí™”ë¥¼ ê±¸ì—ˆì„ ë•Œ ìˆ˜ì‹ ì ì…ì¥ì„ --ë‚´ê°€ ë¹„ë””ì˜¤ì— ì—°ê²°ì´ ì•ˆë˜ì–´ ìˆìœ¼ë©´ ê·¸ê±¸ ì—°ê²°í•˜ëŠ” ë¡œì§
            if (!localStream) {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById("localVideo").srcObject = localStream;

                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // 3.answer ìƒì„±
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            console.log("ğŸ“„ Answer ìƒì„± ì™„ë£Œ:", answer);

            // 4.signal ì„œë²„ë¡œ Answer ì „ì†¡
            sendSignal("answer", answer);
        }

        // offerë¥¼ ë³´ë‚¸ ìª½ì´ ìƒëŒ€ë°©ì˜ answerë¥¼ ìˆ˜ì‹ í•  ë•Œ ì‚¬ìš©í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
        async function handleAnswer(signal) {
            console.log("handleAnswer() - Answer ìˆ˜ì‹ :", signal);

            // 1.answer ê°ì²´ ìƒì„±
            const answerDesc = new RTCSessionDescription(signal.data);
            // 2.answer ë¥¼ ë‚´ remoteDescription ìœ¼ë¡œ ì„¤ì •
            await peerConnection.setRemoteDescription(answerDesc);

            console.log("âœ… setRemoteDescription(answer) ì™„ë£Œ - ì—°ê²° ì„±ë¦½!");
        }

        // ICE í›„ë³´ ìˆ˜ì‹  ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
        async function handleIce(signal) {
            console.log("handleIce() - ICE ìˆ˜ì‹ :", signal);

            try {
                const candidate = new RTCIceCandidate(signal.data);
                await peerConnection.addIceCandidate(candidate);
                console.log("ICE í›„ë³´ ë“±ë¡ ì™„ë£Œ" + candidate);
            } catch (err) {
                console.error("âŒ ICE ë“±ë¡ ì‹¤íŒ¨:", err);
            }
        }
    </script>
</body>

</html>