<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<style>
    body {
        font-family: 'Apple SD Gothic Neo', sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f8f9fa;
        padding: 40px;
    }

    h2 {
        margin-bottom: 20px;
    }

    .video-wrapper {
        display: flex;
        gap: 20px;
    }

    video {
        width: 400px;
        height: 300px;
        border-radius: 12px;
        border: 3px solid #adb5bd;
        background-color: black;
    }

    button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        background-color: #4dabf7;
        color: white;
        border-radius: 8px;
        cursor: pointer;
    }

    button:hover {
        background-color: #339af0;
    }
</style>

<body>
    <h2>화상 통화</h2>
    <div class="video-wrapper">
        <video id="localVideo" autoplay playsinline muted></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <button onclick="startCamera()">시작하기</button>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get("roomId" || "defaultRoom");
        const senderId = urlParams.get("userId") || "anonymous";

        let localStream;
        let peerConnection;
        let stompClient = null;

        // 구글 stun 서버 
        const config = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" }
            ]
        };

        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;

                connectSocket(); //STOMP 먼저 연결 
                setupPeerConnection();

            } catch (err) {
                console.error("카메라/마이크 접근 실패:", err);
                alert("카메라 또는 마이크 권한을 허용해주세요.");
            }
        }

        function connectSocket() {
            const socket = new SockJS("/ws-chat");
            stompClient = Stomp.over(socket);

            stompClient.connect({}, () => {
                console.log("✅ STOMP 연결 성공");

                stompClient.subscribe(`/topic/signal/${roomId}`, (message) => {
                    const signal = JSON.parse(message.body);
                    console.log("📥 받은 시그널:", signal);

                    if (signal.type === "offer") {
                        handleOffer(signal);
                    } else if (signal.type === "answer") {
                        handleAnswer(signal);
                    } else if (signal.type === "ice") {
                        handleIce(signal);
                    }
                })
            })
        }

        function setupPeerConnection() {
            peerConnection = new RTCPeerConnection(config);

            // 1. 로컬 스트림 연결
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });


            // 2. ICE 후보 발생 시 콘솔 출력
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    console.log("📡 ICE Candidate:", event.candidate);
                    sendSignal("ice", event.candidate); //ice 도 시그널 전송
                }
            }

            // 3. 원격 스트림 수신 (아직은 없음)
            peerConnection.ontrack = event => {
                console.log("📺 Remote track received", event.streams[0]);
                // 추후 remoteVideo에 붙일 예정
            }

            // 4. SDP Offer 생성
            peerConnection.createOffer()
                .then(offer => {
                    return peerConnection.setLocalDescription(offer)
                })
                .then(() => {
                    console.log("📄 SDP Offer 생성 완료:" + peerConnection.localDescription);
                    sendSignal("offer", peerConnection.localDescription); // ✅ signaling 서버로 offer 전송
                })
                .catch(err => {
                    console.error("Offer 생성 중 오류:", err);
                })
        }

        

        // signal 메시지 전송 함수 
        function sendSignal(type, data) {
            const message = {
                type: type,
                senderId, // 실제 로그인 사용자 ID로 변경 필요
                data: data
            };
            stompClient.send(`/app/${type}/${roomId}`, {}, JSON.stringify(message));
        }

        // 상대방이 offer를 수신했을 때 수행되는 핵심 함수
        async function handleOffer(signal) {
            console.log("handleOffer() - Offer 수신:" + signal);

            const offerDesc = new RTCSessionDescription(signal.data);

            // 1.수신한 offer 를 remoteDescription으로 설정 
            await peerConnection.setRemoteDescription(offerDesc);
            console.log("✅ setRemoteDescription(offer) 완료");

            // 2.로컬 스트림이 연결 안 되어 있으면 연결 
            // 상대방이 영상통화를 걸었을 때 수신자 입장임 --내가 비디오에 연결이 안되어 있으면 그걸 연결하는 로직
            if (!localStream) {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById("localVideo").srcObject = localStream;

                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // 3.answer 생성
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            console.log("📄 Answer 생성 완료:", answer);

            // 4.signal 서버로 Answer 전송
            sendSignal("answer", answer);
        }

        // offer를 보낸 쪽이 상대방의 answer를 수신할 때 사용하는 핵심 함수
        async function handleAnswer(signal) {
            console.log("handleAnswer() - Answer 수신:", signal);

            // 1.answer 객체 생성
            const answerDesc = new RTCSessionDescription(signal.data);
            // 2.answer 를 내 remoteDescription 으로 설정
            await peerConnection.setRemoteDescription(answerDesc);

            console.log("✅ setRemoteDescription(answer) 완료 - 연결 성립!");
        }

        // ICE 후보 수신 시 실행되는 함수
        async function handleIce(signal) {
            console.log("handleIce() - ICE 수신:", signal);

            try {
                const candidate = new RTCIceCandidate(signal.data);
                await peerConnection.addIceCandidate(candidate);
                console.log("ICE 후보 등록 완료" + candidate);
            } catch (err) {
                console.error("❌ ICE 등록 실패:", err);
            }
        }
    </script>
</body>

</html>