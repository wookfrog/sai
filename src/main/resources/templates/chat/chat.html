<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>커플 채팅</title>

  <!-- 외부 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <style>
    :root{
      --bg:#fff7fb; --text:#2b2b2b; --sub:#8b8f98; --border:#eceff3; --white:#fff;
      --pink:#ff94b3; --grad-a:#7f5aff; --grad-b:#ff79bb;
      --shadow:0 8px 24px rgba(0,0,0,.06);
      --font:'Apple SD Gothic Neo','Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:var(--font);}
    #chat-container{height:100dvh;max-width:720px;margin:0 auto;display:flex;flex-direction:column;background:var(--white);box-shadow:var(--shadow);}
    #chat-header{position:sticky;top:0;z-index:10;height:56px;display:flex;align-items:center;justify-content:center;font-weight:800;letter-spacing:.2px;background:var(--white);border-bottom:1px solid var(--border);}
    #chat-box{list-style:none;margin:0;padding:14px 12px 90px;flex:1;overflow:auto;background:var(--bg);}
    #chat-box li{display:flex;flex-direction:column;gap:4px;margin:12px 0;max-width:74%;}
    #chat-box li.other-message{align-self:flex-start;}
    #chat-box li.my-message{align-self:flex-end;}
    #chat-box .nickname{font-size:12px;color:var(--sub);margin:0 6px;}
    #chat-box .meta{font-size:11px;color:var(--sub);margin:4px 6px 0;}
    #chat-box li>div:nth-child(2){padding:10px 12px;line-height:1.4;border-radius:18px;box-shadow:var(--shadow);word-break:break-word;background:#fff;border:1px solid var(--border);position:relative;}
    #chat-box li.other-message>div:nth-child(2)::after{content:"";position:absolute;left:-6px;bottom:10px;width:12px;height:12px;background:#fff;border-left:1px solid var(--border);border-bottom:1px solid var(--border);transform:rotate(45deg);}
    #chat-box li.my-message>div:nth-child(2){background:var(--pink);color:#fff;border:none;}
    #chat-box li.my-message>div:nth-child(2)::after{content:"";position:absolute;right:-6px;bottom:10px;width:12px;height:12px;background:var(--pink);transform:rotate(45deg);}
    #chat-box li>div:nth-child(2) img{display:block;width:100%;height:auto;border-radius:14px;}
    #chat-input{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:10px;display:flex;align-items:center;gap:8px;}
    #chat-input input{flex:1;height:44px;border:1px solid var(--border);border-radius:999px;padding:0 14px;font-size:15px;background:#fff;}
    #chat-input button{height:44px;min-width:88px;border:0;border-radius:999px;cursor:pointer;color:#fff;font-weight:800;background:linear-gradient(135deg,var(--grad-a),var(--grad-b));box-shadow:var(--shadow);}
    #chat-input button:active{transform:translateY(1px);}
    #chat-box::-webkit-scrollbar{width:8px;}
    #chat-box::-webkit-scrollbar-thumb{background:#e7d9ff;border-radius:8px;}
    #chat-box::-webkit-scrollbar-track{background:transparent;}
    @media (min-width:600px){#chat-box li{max-width:64%;}}
  </style>
</head>
<body>

  <div id="chat-container">
    <div id="chat-header"><span id="chat-title">로딩중…</span></div>
    <ul id="chat-box"></ul>
    <div id="chat-input">
      <input type="text" id="inputMsg" placeholder="메시지를 입력하세요"/>
      <button id="sendBtn" onclick="sendMessage()">전송</button>
    </div>
  </div>

  <!-- 서버(Thymeleaf)에서 coupleId 내려주는 스크립트: 이게 먼저 있어야 아래 JS에서 읽음 -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    const coupleIdFromServer = /*[[${coupleId}]]*/ null;
    /*]]>*/
  </script>

  <script>
    // === 화면 디버그 패널 생성 + logUI 함수 (항상 맨 위) ===
    // (function(){
    //   const d=document.createElement('div');
    //   d.id='debug';
    //   d.style.cssText='position:fixed;left:8px;bottom:8px;background:#000;color:#0f0;font:12px/1.4 monospace;padding:6px 8px;border-radius:6px;z-index:9999;opacity:.9;max-width:60vw;max-height:40vh;overflow:auto;white-space:pre-wrap;';
    //   document.body.appendChild(d);
    // })();
    const logUI=(...a)=>{};

    // ===== 강제 디버그 훅 =====
    console.log("[BOOT] chat page JS loaded");
    logUI("[BOOT] chat page JS loaded");
    window.addEventListener("error",(e)=>{console.error("[WINDOW ERROR]",e.message,e.error);logUI("[WINDOW ERROR]",e.message);});
    window.addEventListener("unhandledrejection",(e)=>{console.error("[PROMISE REJECTED]",e.reason);logUI("[PROMISE REJECTED]",String(e.reason));});
    // =========================

    let coupleId, senderId, myNickname, partnerNickname;
    let stompClient;
    const chatBox   = document.getElementById("chat-box");
    const chatTitle = document.getElementById("chat-title");

    // 0) 서버에서 내려준 coupleId 우선
    coupleId = (typeof coupleIdFromServer !== "undefined" && coupleIdFromServer) ? Number(coupleIdFromServer) : null;

    // 1) URL (/chat/room/{id})에서 추출
    function parseCoupleIdFromURL(){
      try{
        const m = location.pathname.match(/\/chat\/room\/(\d+)/);
        return m ? Number(m[1]) : null;
      }catch{ return null; }
    }
    if(!coupleId) coupleId = parseCoupleIdFromURL();

    console.log("[INIT] coupleId =", coupleId);
    logUI("[INIT] coupleId =", String(coupleId));

    // 2) 채팅 기본 정보
    fetch("/chat/info")
      .then(res => { console.log("[FETCH] /chat/info status", res.status); logUI("[FETCH] /chat/info", res.status); return res.json(); })
      .then(data => {
        console.log("[FETCH] /chat/info payload", data);
        logUI("[INFO] me=", String(data.userId), " partner=", String(data.partnerNickname||""));
        senderId = data.userId;
        myNickname = data.nickname;
        partnerNickname = data.partnerNickname || data.partner_name || data.partner || "상대";
        chatTitle.textContent = partnerNickname;

        if(!coupleId && data.coupleId) coupleId = Number(data.coupleId);

        if(!coupleId){
          chatTitle.textContent = "커플 정보가 필요합니다";
          document.getElementById("chat-input").style.display = "none";
          console.warn("[ABORT] coupleId 없음");
          logUI("[ABORT] coupleId 없음");
          return;
        }

        connectWebSocket();
        loadChatHistory();
      })
      .catch(err => { console.error("[FETCH ERROR] /chat/info", err); logUI("[FETCH ERROR] /chat/info"); chatTitle.textContent="네트워크 오류"; });

    // 3) WebSocket 연결
    function connectWebSocket(){
      if(!coupleId){ logUI("[ABORT] coupleId 없음"); return; }

      logUI("[WS] connect → /ws-chat (coupleId="+coupleId+")");
      const socket = new SockJS("/ws-chat");
      stompClient = Stomp.over(socket);

      // STOMP 로그 -> 화면
      stompClient.debug = (msg)=>logUI("[STOMP]", msg);

      console.time("ws-connect");
      stompClient.connect({},
        () => { // onConnect
          console.timeEnd("ws-connect");
          logUI("[WS] connected");

          const dest = "/topic/room/" + coupleId;
          logUI("[SUB]", dest);

          stompClient.subscribe(dest, (message) => {
            const body = (message && message.body) ? message.body : "";
            logUI("[MSG]", body.slice(0, 120));
            if(!body) return;

            const msg = JSON.parse(body);
            appendMessage(msg);

            // RTT 계산 (clientMsgId 반사 기준)
            if (msg.clientMsgId && pendingRtt[msg.clientMsgId]) {
              const rtt = Date.now() - pendingRtt[msg.clientMsgId];
              logUI("RTT(ms):", String(rtt));
              delete pendingRtt[msg.clientMsgId];
            }
          });
        },
        (error) => { // onError
          console.error("[WS ERROR] connect failed", error);
          logUI("[WS ERROR]", String(error));
        }
      );
    }

    // 4) 입력/전송
    document.getElementById("inputMsg").addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    const pendingRtt = {};

    function sendMessage(){
      const input = document.getElementById("inputMsg");
      const content = input.value.trim();
      if(!stompClient || !content){
        if(!stompClient) { console.warn("[SEND BLOCKED] stompClient not ready"); logUI("[SEND BLOCKED] stomp not ready"); }
        return;
      }

      const clientMsgId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
      pendingRtt[clientMsgId] = Date.now();

      const msg = {
        coupleId,
        senderUserId: senderId,
        senderNickname: myNickname,
        messageType: "TEXT",
        content,
        clientMsgId // 서버가 그대로 되돌려줘야 RTT 계산 가능
      };

      console.log("[SEND]", msg);
      logUI("[SEND]", JSON.stringify(msg).slice(0,120));
      stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(msg));
      input.value = "";
    }

    // 5) 메시지 렌더링
    function appendMessage(msg){
      const time  = msg.sentAt ? new Date(msg.sentAt).toLocaleTimeString() : "";
      const isMine = Number(msg.senderUserId) === Number(senderId);

      const li = document.createElement("li");
      li.className = isMine ? "my-message" : "other-message";
      li.innerHTML = `
        <div class="nickname">${isMine ? escapeHTML(myNickname) : escapeHTML(msg.senderNickname || partnerNickname)}</div>
        <div>${escapeHTML(msg.content || "")}</div>
        <div class="meta">${time}${isMine && msg.isRead ? " · 읽음" : ""}</div>
      `;
      chatBox.appendChild(li);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 6) 히스토리/읽음
    function loadChatHistory(){
      console.time("history-load");
      fetch("/chat/history/" + coupleId)
        .then(res => { console.log("[FETCH] /chat/history", res.status); logUI("[FETCH] /chat/history", res.status); return res.json(); })
        .then(list => {
          console.timeEnd("history-load");
          logUI("[HISTORY] count", String(list?.length||0));
          chatBox.innerHTML = "";
          (list||[]).forEach(appendMessage);
          markAsRead();
        })
        .catch(err => { console.error("[FETCH ERROR] /chat/history", err); logUI("[FETCH ERROR] /chat/history"); });
    }

    function markAsRead(){
      fetch("/chat/read/" + coupleId, { method:"POST" })
        .then(res => { console.log("[POST] /chat/read", res.status); logUI("[POST] /chat/read", res.status); })
        .catch(err => { console.error("[POST ERROR] /chat/read", err); logUI("[POST ERROR] /chat/read"); });
    }

    // 7) XSS 방지
    function escapeHTML(s){
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
  </script>
</body>
</html>
